<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BWR - Bobertovo Web Resources</title>
    <link rel="stylesheet" href="wiki-style.css">
</head>
<body>
    <div class="wiki-container">
        <div class="wiki-header">
            <h1 class="wiki-logo">BWR</h1>
            <p class="wiki-subtitle">Bobertovo Web Resources</p>
            <p class="welcome-text">Welcome to BWR - your comprehensive resource hub for the Bobertovo community. Explore our marketplace, discover job opportunities, and contribute to our growing knowledge base.</p>
        </div>

        <div class="search-section">
            <input type="text" id="wikiSearch" class="wiki-search" placeholder="Search BWR Wiki...">
        </div>

        <div class="menu-button" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </div>

        <div class="dropdown-menu" id="dropdownMenu">
            <a href="marketplace.html" class="menu-item marketplace-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="9" cy="21" r="1"></circle>
                    <circle cx="20" cy="21" r="1"></circle>
                    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
                <span>Marketplace</span>
            </a>
            <a href="marketplace.html#jobs" class="menu-item job-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                    <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                </svg>
                <span>Jobs</span>
            </a>
            <a href="marketplace.html#estate" class="menu-item estate-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 21h18M5 21V7l8-4 8 4v14M8 21V12a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v9"></path>
                </svg>
                <span>BWR Estate</span>
            </a>
        </div>

        <div class="wiki-content">
            <div class="add-article-btn" onclick="openArticleModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>Create New Article</span>
            </div>

            <div id="articlesGrid" class="articles-grid">
                <div class="loading">Loading articles...</div>
            </div>

            <div id="searchResults" class="articles-grid" style="display: none;">
            </div>
        </div>
    </div>

    <!-- Article Creation Modal -->
    <div id="articleModal" class="modal" onclick="closeModalOnOutside(event, 'articleModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Article</h2>
                <button class="close-btn" onclick="closeModal('articleModal')">&times;</button>
            </div>
            <form id="articleForm">
                <div class="form-group">
                    <label>Title <span class="required">*</span></label>
                    <input type="text" id="articleTitle" required placeholder="Article title">
                </div>

                <div class="form-group">
                    <label>Short Description <span class="required">*</span></label>
                    <input type="text" id="articleDesc" required placeholder="Brief description (appears in preview)">
                </div>

                <div class="form-group">
                    <label>Logo Image URL <span class="required">*</span></label>
                    <input type="url" id="articleLogo" required placeholder="https://example.com/logo.jpg">
                </div>

                <div class="form-group">
                    <label>Tags (up to 3, 2-10 characters each) <span class="required">*</span></label>
                    <input type="text" id="articleTags" required placeholder="tag1, tag2, tag3" maxlength="50">
                    <small>Separate tags with commas</small>
                </div>

                <div class="form-group">
                    <label>Subtitle</label>
                    <input type="text" id="articleSubtitle" placeholder="Optional subtitle for full article page">
                </div>

                <div id="sectionsContainer">
                    <div class="section-group" data-section="0">
                        <div class="section-header">
                            <h3>Section 1</h3>
                        </div>
                        <div class="form-group">
                            <label>Section Content <span class="required">*</span></label>
                            <textarea class="section-content" required placeholder="Write your article content here..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Image URLs (up to 2 per section)</label>
                            <input type="url" class="section-image" placeholder="https://example.com/image1.jpg">
                            <input type="url" class="section-image" placeholder="https://example.com/image2.jpg">
                        </div>
                    </div>
                </div>

                <button type="button" class="add-section-btn" onclick="addSection()">+ Add Another Section</button>

                <div class="form-group">
                    <label>Library Images (up to 10 URLs, displayed at bottom)</label>
                    <textarea id="libraryImages" placeholder="https://example.com/img1.jpg&#10;https://example.com/img2.jpg&#10;One URL per line..." rows="4"></textarea>
                    <small>One URL per line</small>
                </div>

                <button type="submit" class="submit-btn wiki-submit">Create Article</button>
            </form>
        </div>
    </div>

    <!-- Article View Modal -->
    <div id="viewModal" class="modal" onclick="closeModalOnOutside(event, 'viewModal')">
        <div class="modal-content article-view-content">
            <button class="close-btn" onclick="closeModal('viewModal')">&times;</button>
            <div id="articleViewContent"></div>
        </div>
    </div>

    <script>
        const GITHUB_USERNAME = 'Forretpw';
        const GITHUB_REPO = 'BWR';
        let allArticles = [];
        let sectionCount = 1;

        function toggleMenu() {
            const menu = document.getElementById('dropdownMenu');
            menu.classList.toggle('active');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function closeModalOnOutside(e, modalId) {
            if (e.target.id === modalId) closeModal(modalId);
        }

        function openArticleModal() {
            openModal('articleModal');
        }

        function addSection() {
            const container = document.getElementById('sectionsContainer');
            sectionCount++;
            const sectionHtml = `
                <div class="section-group" data-section="${sectionCount - 1}">
                    <div class="section-header">
                        <h3>Section ${sectionCount}</h3>
                        <button type="button" class="remove-section-btn" onclick="removeSection(this)">Remove</button>
                    </div>
                    <div class="form-group">
                        <label>Section Content <span class="required">*</span></label>
                        <textarea class="section-content" required placeholder="Write your article content here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Image URLs (up to 2 per section)</label>
                        <input type="url" class="section-image" placeholder="https://example.com/image1.jpg">
                        <input type="url" class="section-image" placeholder="https://example.com/image2.jpg">
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', sectionHtml);
        }

        function removeSection(btn) {
            const section = btn.closest('.section-group');
            section.remove();
        }

        function validateTags(tagsString) {
            const tags = tagsString.split(',').map(t => t.trim()).filter(t => t.length > 0);
            if (tags.length === 0 || tags.length > 3) {
                alert('Please provide 1-3 tags');
                return null;
            }
            for (let tag of tags) {
                if (tag.length < 2 || tag.length > 10) {
                    alert(`Tag "${tag}" must be between 2 and 10 characters`);
                    return null;
                }
            }
            return tags;
        }

        document.getElementById('articleForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const title = document.getElementById('articleTitle').value;
            const desc = document.getElementById('articleDesc').value;
            const logo = document.getElementById('articleLogo').value;
            const tagsInput = document.getElementById('articleTags').value;
            const subtitle = document.getElementById('articleSubtitle').value;
            const libraryImages = document.getElementById('libraryImages').value;

            const tags = validateTags(tagsInput);
            if (!tags) return;

            const sections = [];
            document.querySelectorAll('.section-group').forEach(section => {
                const content = section.querySelector('.section-content').value;
                const images = Array.from(section.querySelectorAll('.section-image'))
                    .map(input => input.value)
                    .filter(url => url.length > 0);
                
                if (content.trim()) {
                    sections.push({ content, images });
                }
            });

            const library = libraryImages.split('\n')
                .map(url => url.trim())
                .filter(url => url.length > 0)
                .slice(0, 10);

            let issueBody = `**Title:** ${title}\n`;
            issueBody += `**Description:** ${desc}\n`;
            issueBody += `**Logo:** ${logo}\n`;
            issueBody += `**Tags:** ${tags.join(', ')}\n`;
            if (subtitle) issueBody += `**Subtitle:** ${subtitle}\n`;
            
            issueBody += `\n**Sections:**\n`;
            sections.forEach((section, idx) => {
                issueBody += `\n--- Section ${idx + 1} ---\n`;
                issueBody += `${section.content}\n`;
                if (section.images.length > 0) {
                    issueBody += `**Images:** ${section.images.join(', ')}\n`;
                }
            });

            if (library.length > 0) {
                issueBody += `\n**Library:**\n${library.join('\n')}`;
            }

            const issueUrl = `https://github.com/${GITHUB_USERNAME}/${GITHUB_REPO}/issues/new?title=${encodeURIComponent(title)}&body=${encodeURIComponent(issueBody)}&labels=BWR-WIKI`;
            window.open(issueUrl, '_blank');
            closeModal('articleModal');
        });

        function renderArticleCard(issue) {
            const body = issue.body;
            const title = body.match(/\*\*Title:\*\* (.+)/)?.[1] || 'Untitled';
            const desc = body.match(/\*\*Description:\*\* (.+)/)?.[1] || '';
            const logo = body.match(/\*\*Logo:\*\* (.+)/)?.[1] || '';
            const tagsMatch = body.match(/\*\*Tags:\*\* (.+)/)?.[1] || '';
            const tags = tagsMatch.split(',').map(t => t.trim());

            return `
                <div class="article-card" onclick="viewArticle(${issue.number})">
                    <img src="${logo}" alt="${title}" class="article-logo" onerror="this.src='https://via.placeholder.com/80/89CFF0/F187B7?text=BWR'">
                    <div class="article-info">
                        <h3 class="article-title">${title}</h3>
                        <p class="article-description">${desc}</p>
                        <div class="article-tags">
                            ${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function viewArticle(issueNumber) {
            const article = allArticles.find(a => a.number === issueNumber);
            if (!article) return;

            const body = article.body;
            const title = body.match(/\*\*Title:\*\* (.+)/)?.[1] || 'Untitled';
            const subtitle = body.match(/\*\*Subtitle:\*\* (.+)/)?.[1] || '';
            
            const sectionsMatch = body.match(/\*\*Sections:\*\*\n([\s\S]*?)(?:\n\*\*Library:\*\*|$)/);
            const libraryMatch = body.match(/\*\*Library:\*\*\n([\s\S]*?)$/);

            let contentHtml = `<h1 class="view-title">${title}</h1>`;
            if (subtitle) {
                contentHtml += `<p class="view-subtitle">${subtitle}</p>`;
            }

            if (sectionsMatch) {
                const sectionsText = sectionsMatch[1];
                const sectionParts = sectionsText.split(/--- Section \d+ ---/).filter(s => s.trim());
                
                sectionParts.forEach(section => {
                    const imageMatch = section.match(/\*\*Images:\*\* (.+)/);
                    const content = section.replace(/\*\*Images:\*\* .+/, '').trim();
                    
                    contentHtml += `<div class="article-section">${content.replace(/\n/g, '<br>')}</div>`;
                    
                    if (imageMatch) {
                        const images = imageMatch[1].split(',').map(url => url.trim());
                        images.forEach(img => {
                            contentHtml += `<img src="${img}" class="section-image" alt="Section image">`;
                        });
                    }
                });
            }

            if (libraryMatch) {
                const libraryUrls = libraryMatch[1].trim().split('\n').filter(url => url.trim());
                if (libraryUrls.length > 0) {
                    contentHtml += `<div class="library-section"><h2>Library</h2><div class="library-grid">`;
                    libraryUrls.forEach(url => {
                        contentHtml += `<img src="${url}" class="library-image" alt="Library image">`;
                    });
                    contentHtml += `</div></div>`;
                }
            }

            document.getElementById('articleViewContent').innerHTML = contentHtml;
            openModal('viewModal');
        }

        async function loadArticles() {
            try {
                const response = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/issues?labels=BWR-WIKI&state=open`);
                const issues = await response.json();
                allArticles = issues;
                const container = document.getElementById('articlesGrid');
                
                if (issues.length === 0) {
                    container.innerHTML = '<div class="loading">No articles yet. Create the first one!</div>';
                    return;
                }
                
                container.innerHTML = issues.map(renderArticleCard).join('');
            } catch (error) {
                document.getElementById('articlesGrid').innerHTML = '<div class="loading">Error loading articles.</div>';
            }
        }

        document.getElementById('wikiSearch').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            const resultsContainer = document.getElementById('searchResults');
            const articlesGrid = document.getElementById('articlesGrid');

            if (!query) {
                resultsContainer.style.display = 'none';
                articlesGrid.style.display = 'grid';
                return;
            }

            const filtered = allArticles.filter(article => {
                const body = article.body;
                const title = body.match(/\*\*Title:\*\* (.+)/)?.[1] || '';
                const desc = body.match(/\*\*Description:\*\* (.+)/)?.[1] || '';
                const tags = body.match(/\*\*Tags:\*\* (.+)/)?.[1] || '';
                
                return title.toLowerCase().includes(query) || 
                       desc.toLowerCase().includes(query) || 
                       tags.toLowerCase().includes(query);
            });

            articlesGrid.style.display = 'none';
            resultsContainer.style.display = 'grid';
            
            if (filtered.length === 0) {
                resultsContainer.innerHTML = '<div class="loading">No articles found</div>';
                return;
            }
            
            resultsContainer.innerHTML = filtered.map(renderArticleCard).join('');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('dropdownMenu');
            const menuBtn = document.querySelector('.menu-button');
            if (!menu.contains(e.target) && !menuBtn.contains(e.target)) {
                menu.classList.remove('active');
            }
        });

        loadArticles();
    </script>
</body>
</html>
